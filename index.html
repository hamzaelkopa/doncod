<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELKOBBA | حمزة القبة</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg-body: #05070a;
            --card-bg: rgba(15, 23, 42, 0.6);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.05);
        }

        .light-theme {
            --bg-body: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.7);
            --text-main: #0f172a;
            --text-dim: #64748b;
            --border-color: rgba(0, 0, 0, 0.05);
        }
        
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            margin: 0;
            font-size: 11px;
            transition: all 0.4s ease;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
        }

        .btn-action {
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 11px;
            color: var(--text-dim);
            cursor: pointer;
            border: 1px solid transparent;
        }

        .btn-action:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .btn-action.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .compact-scroll::-webkit-scrollbar { width: 4px; }
        .compact-scroll::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        .surah-card {
            padding: 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: 0.3s;
        }
        .surah-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            background: rgba(99, 102, 241, 0.08);
        }
        .surah-card.playing {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.15);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
        }

        #canvas-bg { position: fixed; top: 0; left: 0; z-index: -1; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 5000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }

        .stat-pill {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 16px;
            text-align: center;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #6366f1;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            transition: transform 0.3s ease;
            z-index: 9999;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        .task-item {
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body id="main-body">

    <canvas id="canvas-bg"></canvas>
    <div id="toast-msg" class="toast text-xs">تم الإجراء بنجاح!</div>

    <!-- Tracker Modal -->
    <div id="modal-tracker" class="modal">
        <div class="glass-card w-full max-w-lg p-6 border-indigo-500/30 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <i data-lucide="activity" class="w-5 h-5 text-indigo-400"></i>
                    <h3 class="font-black text-sm">تتبع الإنجازات الزمني</h3>
                </div>
                <button onclick="closeModal('tracker')" class="p-2 hover:bg-white/5 rounded-full"><i data-lucide="x" class="w-5 h-5 text-red-400"></i></button>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="stat-pill">
                    <div class="text-[9px] opacity-40 mb-1">إنجاز اليوم</div>
                    <div id="stat-day" class="text-xl font-black text-indigo-400">0</div>
                </div>
                <div class="stat-pill">
                    <div class="text-[9px] opacity-40 mb-1">هذا الأسبوع</div>
                    <div id="stat-week" class="text-xl font-black text-purple-400">0</div>
                </div>
                <div class="stat-pill">
                    <div class="text-[9px] opacity-40 mb-1">هذا الشهر</div>
                    <div id="stat-month" class="text-xl font-black text-blue-400">0</div>
                </div>
                <div class="stat-pill">
                    <div class="text-[9px] opacity-40 mb-1">إجمالي النقاط</div>
                    <div id="stat-xp" class="text-xl font-black text-green-400">0</div>
                </div>
            </div>

            <div class="h-48 relative mb-4">
                <canvas id="trackerChart"></canvas>
            </div>
            <p class="text-[9px] text-center opacity-40">يتم تحديث المبيان تلقائياً بناءً على تاريخ مهامك المكتملة.</p>
        </div>
    </div>

    <!-- Confirm Clear Modal -->
    <div id="modal-clear" class="modal">
        <div class="glass-card w-full max-w-sm p-8 text-center border-red-500/30">
            <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
            <h3 class="font-black text-sm mb-2">تأكيد مسح كافة البيانات؟</h3>
            <p class="text-[10px] opacity-50 mb-6">سيتم حذف المهام، التاريخ، والنقاط نهائياً ولا يمكن التراجع.</p>
            <div class="flex gap-3">
                <button onclick="clearAllData()" class="flex-1 bg-red-600 py-3 rounded-xl font-bold">نعم، امسح الكل</button>
                <button onclick="closeModal('clear')" class="flex-1 bg-white/5 py-3 rounded-xl font-bold">تراجع</button>
            </div>
        </div>
    </div>

    <div class="flex h-screen p-4 gap-4">
        <!-- Sidebar -->
        <aside class="w-16 md:w-52 glass-card flex flex-col p-4 shadow-xl">
            <div class="mb-8 text-center">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl mx-auto flex items-center justify-center mb-3 shadow-lg shadow-indigo-500/20">
                    <i data-lucide="zap" class="w-5 h-5 text-white"></i>
                </div>
                <div class="hidden md:block">
                    <div class="h-1.5 bg-white/5 rounded-full overflow-hidden mb-1">
                        <div id="xp-fill" class="h-full bg-gradient-to-l from-indigo-500 to-purple-500 w-0 transition-all duration-700"></div>
                    </div>
                    <div class="flex justify-between text-[8px] font-black opacity-50">
                        <span>Lvl <span id="level-side">1</span></span>
                        <span>XP <span id="xp-val">0</span></span>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 space-y-2">
                <button onclick="switchView('main')" id="nav-main" class="btn-action active">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i>
                    <span class="hidden md:block font-bold">الرئيسية</span>
                </button>
                <button onclick="switchView('audio')" id="nav-audio" class="btn-action">
                    <i data-lucide="music-4" class="w-4 h-4"></i>
                    <span class="hidden md:block font-bold">المصحف المرتل</span>
                </button>
                <button onclick="openTracker()" class="btn-action">
                    <i data-lucide="line-chart" class="w-4 h-4"></i>
                    <span class="hidden md:block font-bold">تتبع المهام</span>
                </button>
                
                <div class="h-px bg-white/5 my-4"></div>

                <button onclick="shareApp()" class="btn-action !text-indigo-400">
                    <i data-lucide="share-2" class="w-4 h-4"></i>
                    <span class="hidden md:block font-bold">مشاركة التطبيق</span>
                </button>
                <button onclick="toggleTheme()" class="btn-action">
                    <i data-lucide="sun-moon" class="w-4 h-4"></i>
                    <span class="hidden md:block font-bold">المظهر</span>
                </button>
                <button onclick="contactSupport()" class="btn-action !text-green-400">
                    <i data-lucide="help-circle" class="w-4 h-4"></i>
                    <span class="hidden md:block font-bold">فريق الدعم</span>
                </button>
                <button onclick="document.getElementById('modal-clear').classList.add('active')" class="btn-action !text-red-400">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    <span class="hidden md:block font-bold">إعادة تعيين</span>
                </button>
            </nav>

            <div class="mt-auto pt-4 border-t border-white/5 text-center hidden md:block">
                <p class="text-[9px] opacity-40 font-bold leading-tight">تم تطويره من قبل <span class="text-indigo-400">حمزة القبة</span></p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col gap-4 overflow-hidden">
            <header class="flex justify-between items-center px-1">
                <h2 class="text-base font-black" id="page-title">لوحة التحكم</h2>
                <div class="flex items-center gap-2">
                    <div id="audio-status" class="hidden flex items-center gap-3 bg-indigo-500/10 px-4 py-2 rounded-full border border-indigo-500/20">
                        <span id="playing-title" class="text-[9px] font-bold">...</span>
                        <button onclick="stopAudio()" class="text-red-400"><i data-lucide="square" class="w-3 h-3"></i></button>
                    </div>
                    <button onclick="showAdvice()" class="w-10 h-10 glass-card flex items-center justify-center text-yellow-400 hover:bg-yellow-400/10 transition-colors shadow-lg">
                        <i data-lucide="lightbulb" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto compact-scroll pr-1">
                <!-- Dashboard View -->
                <div id="section-main" class="view-section active">
                    <div id="advice-container" class="mb-4 bg-gradient-to-r from-indigo-600/20 to-purple-600/20 border border-indigo-500/30 p-4 rounded-2xl flex items-start gap-4" style="display:none;">
                        <div class="mt-1 p-2 bg-indigo-600 rounded-lg"><i data-lucide="sparkles" class="w-4 h-4 text-white"></i></div>
                        <div class="flex-1">
                            <h4 class="text-[10px] font-black opacity-50 mb-1">نصيحة ذكية</h4>
                            <p id="advice-text" class="text-xs font-bold leading-relaxed">...</p>
                        </div>
                        <button onclick="document.getElementById('advice-container').style.display = 'none'"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
                        <div class="lg:col-span-8">
                            <div class="glass-card p-6 border-t-4 border-t-indigo-500">
                                <form onsubmit="event.preventDefault(); addTask();" class="flex gap-3 mb-6">
                                    <input type="text" id="task-input" placeholder="اكتب مهمة جديدة..." class="flex-1 bg-white/5 border border-white/10 rounded-xl px-5 py-3 text-[11px] outline-none focus:border-indigo-500 transition-all">
                                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 w-12 h-12 rounded-xl text-white shadow-lg flex items-center justify-center">
                                        <i data-lucide="plus" class="w-6 h-6"></i>
                                    </button>
                                </form>
                                <div id="task-list" class="space-y-3"></div>
                            </div>
                        </div>
                        <div class="lg:col-span-4">
                            <div class="glass-card p-6 text-center shadow-xl">
                                <div id="timer-display" class="text-5xl font-black mb-6 tracking-tighter text-indigo-500">25:00</div>
                                <div class="flex gap-2">
                                    <button onclick="toggleTimer()" id="timer-btn" class="flex-1 bg-indigo-600 py-3 rounded-xl font-bold text-[11px]">ابدأ التركيز</button>
                                    <button onclick="resetTimer()" class="px-4 bg-white/5 rounded-xl border border-white/10"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audio View -->
                <div id="section-audio" class="view-section">
                    <div class="glass-card p-6">
                        <input type="text" id="surah-search" oninput="filterSurahs()" placeholder="بحث في السور..." class="w-full bg-white/5 border border-white/10 px-4 py-4 rounded-2xl text-[12px] mb-6 outline-none focus:border-indigo-500">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4" id="audio-grid"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const surahs = ["الفاتحة", "البقرة", "آل عمران", "النساء", "المائدة", "الأنعام", "الأعراف", "الأنفال", "التوبة", "يونس", "هود", "يوسف", "الرعد", "إبراهيم", "الحجر", "النحل", "الإسراء", "الكهف", "مريم", "طه", "الأنبياء", "الحج", "المؤمنون", "النور", "الفرقان", "الشعراء", "النمل", "القصص", "العنكبوت", "الروم", "لقمان", "السجدة", "الأحزاب", "سبأ", "فاطر", "يس", "الصافات", "ص", "الزمر", "غافر", "فصلت", "الشورى", "الزخرف", "الدخان", "الجاثية", "الأحقاف", "محمد", "الفتح", "الحجرات", "ق", "الذاريات", "الطور", "النجم", "القمر", "الرحمن", "الواقعة", "الحديد", "المجادلة", "الحشر", "الممتحنة", "الصف", "الجمعة", "المنافقون", "التغابن", "الطلاق", "التحريم", "الملك", "القلم", "الحاقة", "المعارج", "نوح", "الجن", "المزمل", "المدثر", "القيامة", "الإنسان", "المرسلات", "النبأ", "النازعات", "عبس", "التكوير", "الانفطار", "المطففين", "الانشقاق", "البروج", "الطارق", "الأعلى", "الغاشية", "الفجر", "البلد", "الشمس", "الليل", "الضحى", "الشرح", "التين", "العلق", "القدر", "البينة", "الزلزلة", "العاديات", "القارعة", "التكاثر", "العصر", "الهمزة", "الفيل", "قريش", "الماعون", "الكوثر", "الكافرون", "النصر", "المسد", "الإخلاص", "الفلق", "الناس"];
        const advices = ["الاستمرارية سر النجاح.", "التركيز يوفر الوقت.", "ابدأ بالمهمة الأهم.", "الإنجاز يولد الثقة.", "لا تؤجل عمل اليوم للغد.", "التنظيم هو مفتاح الحرية."];

        let state = {
            tasks: JSON.parse(localStorage.getItem('elk_tasks')) || [], 
            history: JSON.parse(localStorage.getItem('elk_history')) || [], 
            xp: parseInt(localStorage.getItem('elk_xp')) || 0,
            isDark: localStorage.getItem('elk_theme') !== 'light',
            timerSeconds: 25 * 60,
            timerInterval: null,
            audio: null,
            chart: null
        };

        function save() {
            localStorage.setItem('elk_tasks', JSON.stringify(state.tasks));
            localStorage.setItem('elk_history', JSON.stringify(state.history));
            localStorage.setItem('elk_xp', state.xp);
            updateXPUI();
        }

        function showAdvice() {
            const container = document.getElementById('advice-container');
            const text = document.getElementById('advice-text');
            text.innerText = advices[Math.floor(Math.random() * advices.length)];
            container.style.display = 'flex';
        }

        function shareApp() {
            const url = "http://doncod.life/";
            const text = "جرب تطبيق القبة لإدارة الوقت والقرآن الكريم:";
            
            // محاولة استخدام واجهة مشاركة النظام
            if (navigator.share) {
                navigator.share({ title: 'ELKOBBA', text: text, url: url })
                    .catch(() => copyToClipboard(url));
            } else {
                copyToClipboard(url);
            }
        }

        // دالة مخصصة للنسخ تدعم متطلبات البيئة
        function copyToClipboard(text) {
            const input = document.createElement('input');
            input.value = text;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            showToast("تم نسخ الرابط: http://doncod.life/");
        }

        function showToast(msg) {
            const t = document.getElementById('toast-msg');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function updateXPUI() {
            const lvl = Math.floor(state.xp / 100) + 1;
            const progress = state.xp % 100;
            const lvlSide = document.getElementById('level-side');
            const xpVal = document.getElementById('xp-val');
            const xpFill = document.getElementById('xp-fill');
            if(lvlSide) lvlSide.innerText = lvl;
            if(xpVal) xpVal.innerText = state.xp;
            if(xpFill) xpFill.style.width = `${progress}%`;
        }

        function addTask() {
            const val = document.getElementById('task-input').value.trim();
            if(!val) return;
            state.tasks.unshift({ 
                id: Date.now(), 
                text: val, 
                completed: false, 
                createdAt: Date.now() 
            });
            document.getElementById('task-input').value = '';
            save();
            renderTasks();
        }

        function completeTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if(task) {
                task.completed = true;
                task.completedAt = Date.now();
                state.history.push({ 
                    id: task.id, 
                    text: task.text, 
                    timestamp: task.completedAt 
                });
                state.xp += 20;
                save();
                renderTasks();
                showToast("إنجاز رائع! +20 نقطة");
            }
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            if(!list) return;
            const now = Date.now();
            const eightHours = 8 * 60 * 60 * 1000;

            const visibleTasks = state.tasks.filter(t => {
                if (!t.completed) return true;
                return (now - t.completedAt) < eightHours;
            });

            list.innerHTML = visibleTasks.map(t => `
                <div class="task-item flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 ${t.completed ? 'opacity-50' : ''}">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full ${t.completed ? 'bg-green-500' : 'bg-indigo-500'}"></div>
                        <span class="font-bold ${t.completed ? 'line-through' : ''}">${t.text}</span>
                    </div>
                    <div class="flex gap-2">
                        ${!t.completed ? `
                            <button onclick="completeTask(${t.id})" class="p-2 bg-indigo-500/10 text-indigo-400 rounded-lg hover:bg-indigo-500 hover:text-white transition-all">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                        ` : `
                            <span class="text-[8px] opacity-40 italic">مكتملة</span>
                        `}
                        <button onclick="deleteTask(${t.id})" class="p-2 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition-all">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            if(visibleTasks.length === 0) list.innerHTML = '<p class="text-center opacity-30 text-[9px] py-10">قائمة المهام فارغة حالياً</p>';
            lucide.createIcons();
        }

        function deleteTask(id) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            save();
            renderTasks();
        }

        function toggleTimer() {
            const btn = document.getElementById('timer-btn');
            if(state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
                btn.innerText = "استئناف";
            } else {
                state.timerInterval = setInterval(() => {
                    if(state.timerSeconds > 0) {
                        state.timerSeconds--;
                        const m = Math.floor(state.timerSeconds / 60);
                        const s = state.timerSeconds % 60;
                        document.getElementById('timer-display').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                    } else {
                        clearInterval(state.timerInterval);
                        state.xp += 50;
                        save();
                        alert("انتهى وقت التركيز! حصلت على 50 نقطة.");
                        resetTimer();
                    }
                }, 1000);
                btn.innerText = "توقف مؤقت";
            }
        }

        function resetTimer() {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
            state.timerSeconds = 25 * 60;
            document.getElementById('timer-display').innerText = "25:00";
            document.getElementById('timer-btn').innerText = "ابدأ التركيز";
        }

        function initAudioGrid() {
            const grid = document.getElementById('audio-grid');
            if(!grid) return;
            grid.innerHTML = surahs.map((name, i) => {
                const id = (i + 1).toString().padStart(3, '0');
                return `
                    <div class="surah-card flex justify-between items-center" id="surah-${id}" onclick="playQuran('${id}', '${name}')">
                        <span class="font-bold">${name}</span>
                        <i data-lucide="play" class="w-3 h-3 opacity-50"></i>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function playQuran(id, name) {
            if(state.audio) state.audio.pause();
            const url = `https://server7.mp3quran.net/basit/${id}.mp3`;
            state.audio = new Audio(url);
            document.getElementById('audio-status').classList.remove('hidden');
            document.getElementById('playing-title').innerText = `تلاوة ${name}`;
            state.audio.play();
            document.querySelectorAll('.surah-card').forEach(c => c.classList.remove('playing'));
            const card = document.getElementById(`surah-${id}`);
            if(card) card.classList.add('playing');
        }

        function stopAudio() {
            if(state.audio) state.audio.pause();
            document.getElementById('audio-status').classList.add('hidden');
            document.querySelectorAll('.surah-card').forEach(c => c.classList.remove('playing'));
        }

        function filterSurahs() {
            const q = document.getElementById('surah-search').value.trim();
            document.querySelectorAll('.surah-card').forEach(card => {
                card.style.display = card.innerText.includes(q) ? 'flex' : 'none';
            });
        }

        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.btn-action').forEach(b => b.classList.remove('active'));
            document.getElementById(`section-${id}`).classList.add('active');
            document.getElementById(`nav-${id}`).classList.add('active');
            
            const titles = { 'main': 'لوحة التحكم', 'audio': 'المصحف المرتل' };
            document.getElementById('page-title').innerText = titles[id] || 'القبة';
        }

        function toggleTheme() {
            state.isDark = !state.isDark;
            localStorage.setItem('elk_theme', state.isDark ? 'dark' : 'light');
            document.getElementById('main-body').classList.toggle('light-theme', !state.isDark);
        }

        function openTracker() {
            document.getElementById('modal-tracker').classList.add('active');
            
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            
            const daily = state.history.filter(h => new Date(h.timestamp).toISOString().split('T')[0] === todayStr).length;
            const weekly = state.history.filter(h => (now - h.timestamp) < 7 * 24 * 60 * 60 * 1000).length;
            const monthly = state.history.filter(h => (now - h.timestamp) < 30 * 24 * 60 * 60 * 1000).length;

            document.getElementById('stat-day').innerText = daily;
            document.getElementById('stat-week').innerText = weekly;
            document.getElementById('stat-month').innerText = monthly;
            document.getElementById('stat-xp').innerText = state.xp;

            setTimeout(renderChart, 200);
        }

        function renderChart() {
            const ctx = document.getElementById('trackerChart').getContext('2d');
            if(state.chart) state.chart.destroy();

            const labels = ['ح', 'ن', 'ث', 'ر', 'خ', 'ج', 'س'];
            const dataCounts = new Array(7).fill(0);
            
            state.history.forEach(h => {
                const day = new Date(h.timestamp).getDay();
                dataCounts[day]++;
            });

            state.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ 
                        label: 'المهام المكتملة',
                        data: dataCounts, 
                        backgroundColor: '#6366f1',
                        borderRadius: 8
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { font: { size: 9 } } },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    } 
                }
            });
        }

        function closeModal(id) { document.getElementById(`modal-${id}`).classList.remove('active'); }
        
        function clearAllData() { 
            localStorage.clear(); 
            location.reload(); 
        }

        function contactSupport() { 
            window.open('https://wa.me/212626014697', '_blank'); 
        }

        function initVisuals() {
            const canvas = document.getElementById('canvas-bg');
            if(!canvas) return;
            const scene = new THREE.Scene();
            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            const geo = new THREE.TorusGeometry(10, 0.05, 16, 100);
            const mat = new THREE.MeshBasicMaterial({ color: 0x6366f1, wireframe: true, transparent: true, opacity: 0.08 });
            const mesh = new THREE.Mesh(geo, mat);
            scene.add(mesh);
            
            const cam = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            cam.position.z = 15;

            function animate() { 
                requestAnimationFrame(animate); 
                mesh.rotation.x += 0.001; 
                mesh.rotation.y += 0.0015; 
                renderer.render(scene, cam); 
            }
            animate();

            window.addEventListener('resize', () => {
                cam.aspect = window.innerWidth / window.innerHeight;
                cam.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        window.onload = () => {
            renderTasks();
            updateXPUI();
            initAudioGrid();
            initVisuals();
            if(!state.isDark) document.getElementById('main-body').classList.add('light-theme');
            lucide.createIcons();
        };
    </script>
</body>
</html>
