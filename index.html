import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
  updateProfile,
  signInWithCustomToken,
  signInAnonymously
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  getDoc, 
  onSnapshot, 
  addDoc, 
  updateDoc, 
  arrayUnion, 
  arrayRemove,
  query,
  orderBy
} from 'firebase/firestore';
import { 
  User, 
  Heart, 
  MessageCircle, 
  PlusSquare, 
  Search, 
  Home, 
  LogOut, 
  Mail, 
  Lock, 
  ArrowRight, 
  BadgeCheck, 
  ShieldCheck, 
  AlertCircle, 
  Eye, 
  Sparkles, 
  Volume2, 
  Wand2, 
  Image as ImageIcon, 
  Loader2,
  UserPlus
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'doncod-ai-v1';
const apiKey = ""; // API Key handled by environment

const ADMIN_ID = "admin_hamza_qubba";
const ADMIN_ACCOUNT = {
  uid: ADMIN_ID,
  name: "حمزة القبة",
  isVerified: true,
  photoURL: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=150&q=80",
  bio: "مالك ومطور منصة doncod. الآن مع ميزات الذكاء الاصطناعي ✨"
};

// --- Gemini API Helpers ---
const fetchGemini = async (prompt, systemPrompt = "") => {
  let retries = 0;
  const delays = [1000, 2000, 4000, 8000, 16000];
  
  const callApi = async () => {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: systemPrompt ? { parts: [{ text: systemPrompt }] } : undefined
      })
    });
    if (!response.ok) throw new Error('API Error');
    const result = await response.json();
    return result.candidates?.[0]?.content?.parts?.[0]?.text;
  };

  while (retries < 5) {
    try {
      return await callApi();
    } catch (e) {
      retries++;
      if (retries === 5) throw e;
      await new Promise(r => setTimeout(r, delays[retries - 1]));
    }
  }
};

const playTTS = async (text) => {
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: `Say in a friendly Arabic voice: ${text}` }] }],
        generationConfig: { 
          responseModalities: ["AUDIO"],
          speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
        },
        model: "gemini-2.5-flash-preview-tts"
      })
    });
    const result = await response.json();
    const base64Audio = result.candidates[0].content.parts[0].inlineData.data;
    const audioBlob = new Blob([Uint8Array.from(atob(base64Audio), c => c.charCodeAt(0))], { type: 'audio/l16' });
    const audioUrl = URL.createObjectURL(audioBlob);
    const audio = new Audio(audioUrl);
    audio.play();
  } catch (e) {
    console.error("TTS Error:", e);
  }
};

export default function App() {
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState(null);
  const [loading, setLoading] = useState(true);
  const [authMode, setAuthMode] = useState('login');
  const [currentPage, setCurrentPage] = useState('feed');
  const [posts, setPosts] = useState([]);
  
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [fullName, setFullName] = useState('');
  const [authError, setAuthError] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    const handleInitialAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) {}
      }
    };
    handleInitialAuth();

    const unsubscribe = onAuthStateChanged(auth, async (u) => {
      if (u) {
        const userProfile = await fetchOrCreateProfile(u);
        setProfile(userProfile);
        setUser(u);
      } else {
        setUser(null);
        setProfile(null);
      }
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  const fetchOrCreateProfile = async (u) => {
    const userRef = doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'info');
    const snap = await getDoc(userRef);
    if (snap.exists()) return snap.data();

    // Handling anonymous or new users
    const isAnonymous = u.isAnonymous;
    const finalName = u.displayName || fullName || (isAnonymous ? `ضيف doncod #${u.uid.slice(0, 4)}` : "مستخدم جديد");
    
    const newProfile = {
      uid: u.uid,
      name: finalName,
      isAnonymous: isAnonymous,
      photoURL: isAnonymous 
        ? `https://api.dicebear.com/7.x/bottts/svg?seed=${u.uid}` 
        : `https://api.dicebear.com/7.x/avataaars/svg?seed=${u.uid}`,
      bio: isAnonymous ? "أنا أتصفح doncod كضيف ✨" : "أنا عضو جديد في عائلة doncod!",
      followers: 0,
      following: 0,
      createdAt: Date.now()
    };
    await setDoc(userRef, newProfile);
    return newProfile;
  };

  const handleAuthAction = async (e) => {
    if (e) e.preventDefault();
    setAuthError('');
    setIsSubmitting(true);

    try {
      if (authMode === 'signup') {
        if (password.length < 6) throw new Error('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
        if (!fullName.trim()) throw new Error('يرجى إدخال اسمك الكامل');
        const res = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(res.user, { displayName: fullName });
      } else if (authMode === 'login') {
        await signInWithEmailAndPassword(auth, email, password);
      }
    } catch (err) {
      let message = "حدث خطأ غير متوقع";
      if (err.code === 'auth/email-already-in-use') message = "البريد الإلكتروني مسجل مسبقاً";
      else if (err.code === 'auth/invalid-email') message = "البريد الإلكتروني غير صحيح";
      else if (err.code === 'auth/wrong-password') message = "كلمة المرور غير صحيحة";
      else if (err.message) message = err.message;
      setAuthError(message);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleGuestLogin = async () => {
    setAuthError('');
    setIsSubmitting(true);
    try {
      await signInAnonymously(auth);
    } catch (err) {
      setAuthError("فشل الدخول كضيف، حاول مرة أخرى");
    } finally {
      setIsSubmitting(false);
    }
  };

  useEffect(() => {
    if (!user) return;
    const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
    const unsub = onSnapshot(postsRef, (snap) => {
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setPosts(list.sort((a, b) => b.createdAt - a.createdAt));
    }, (err) => console.error(err));
    return () => unsub();
  }, [user]);

  if (loading) return (
    <div className="h-screen flex items-center justify-center bg-white">
      <Loader2 className="w-10 h-10 text-purple-600 animate-spin" />
    </div>
  );

  if (!user) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6 font-sans" dir="rtl">
        <div className="w-full max-w-md bg-white rounded-[3rem] shadow-2xl border border-white p-10">
          <div className="text-center mb-10">
            <div className="inline-block p-4 bg-purple-100 rounded-[2rem] mb-4">
              <ShieldCheck className="text-purple-600" size={40} />
            </div>
            <h1 className="text-4xl font-black text-slate-900 tracking-tighter">doncod</h1>
            <p className="text-slate-400 font-medium mt-2">عالم التواصل الاجتماعي الذكي</p>
          </div>

          <form onSubmit={handleAuthAction} className="space-y-4">
            {authMode === 'signup' && (
              <div className="relative">
                <User className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                <input 
                  type="text" placeholder="الاسم الكامل" required
                  className="w-full bg-slate-50 border-0 rounded-2xl py-4 pr-12 pl-4 focus:ring-2 focus:ring-purple-200 outline-none"
                  value={fullName} onChange={e => setFullName(e.target.value)}
                />
              </div>
            )}
            <div className="relative">
              <Mail className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
              <input 
                type="email" placeholder="البريد الإلكتروني" required
                className="w-full bg-slate-50 border-0 rounded-2xl py-4 pr-12 pl-4 focus:ring-2 focus:ring-purple-200 outline-none"
                value={email} onChange={e => setEmail(e.target.value)}
              />
            </div>
            <div className="relative">
              <Lock className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
              <input 
                type="password" placeholder="كلمة المرور" required
                className="w-full bg-slate-50 border-0 rounded-2xl py-4 pr-12 pl-4 focus:ring-2 focus:ring-purple-200 outline-none"
                value={password} onChange={e => setPassword(e.target.value)}
              />
            </div>

            {authError && (
              <div className="flex items-center gap-2 text-red-500 bg-red-50 p-4 rounded-2xl text-xs font-bold border border-red-100 animate-in fade-in duration-300">
                <AlertCircle size={14} className="shrink-0" />
                <span>{authError}</span>
              </div>
            )}

            <button 
              disabled={isSubmitting}
              type="submit" 
              className="w-full bg-purple-600 text-white py-4 rounded-2xl font-black text-lg hover:bg-purple-700 transition-all flex items-center justify-center gap-2 shadow-xl shadow-purple-100 disabled:opacity-50"
            >
              {isSubmitting ? <Loader2 className="animate-spin" size={20} /> : (authMode === 'login' ? 'دخول' : 'إنشاء حساب جديد')}
            </button>
          </form>

          <div className="relative my-8">
            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-100"></div></div>
            <div className="relative flex justify-center text-xs uppercase"><span className="bg-white px-2 text-slate-300 font-bold">أو</span></div>
          </div>

          <button 
            onClick={handleGuestLogin}
            disabled={isSubmitting}
            className="w-full bg-white border-2 border-slate-100 text-slate-600 py-4 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-slate-50 transition-all disabled:opacity-50"
          >
            <UserPlus size={20} className="text-purple-600" />
            الدخول كضيف (سريع)
          </button>

          <div className="mt-8 text-center">
            <button 
              onClick={() => { setAuthMode(authMode === 'login' ? 'signup' : 'login'); setAuthError(''); }}
              className="text-slate-500 text-sm font-bold hover:text-purple-600 transition-colors"
            >
              {authMode === 'login' ? 'ليس لديك حساب؟ انضم إلينا الآن' : 'تملك حساباً بالفعل؟ سجل دخولك'}
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans flex flex-col md:flex-row" dir="rtl">
      {/* Sidebar - Desktop */}
      <nav className="hidden md:flex flex-col w-72 bg-white border-l border-slate-100 h-screen sticky top-0 p-6 shadow-sm">
        <h1 className="text-3xl font-black text-purple-600 mb-10 px-2 tracking-tighter">doncod</h1>
        <div className="space-y-2 flex-grow">
          <SideLink icon={<Home />} label="الرئيسية" active={currentPage === 'feed'} onClick={() => setCurrentPage('feed')} />
          <SideLink icon={<Search />} label="اكتشف" active={currentPage === 'search'} onClick={() => setCurrentPage('search')} />
          <SideLink icon={<PlusSquare />} label="نشر" active={currentPage === 'create'} onClick={() => setCurrentPage('create')} />
          <SideLink icon={<User />} label="ملفي" active={currentPage === 'profile'} onClick={() => setCurrentPage('profile')} />
        </div>
        <div className="pt-6 border-t border-slate-50">
          <button onClick={() => signOut(auth)} className="flex items-center gap-3 p-4 w-full rounded-2xl text-red-500 hover:bg-red-50 transition-colors font-bold">
            <LogOut size={20} />
            <span>تسجيل الخروج</span>
          </button>
        </div>
      </nav>

      {/* Main Content */}
      <main className="flex-grow max-w-2xl mx-auto w-full pb-20 md:pb-8">
        <header className="md:hidden bg-white border-b border-slate-50 p-4 sticky top-0 z-50 flex justify-between items-center">
          <h1 className="text-2xl font-black text-purple-600 tracking-tighter">doncod</h1>
          <button onClick={() => signOut(auth)} className="text-slate-400"><LogOut size={20} /></button>
        </header>

        <div className="p-4 md:p-8">
          {profile?.isAnonymous && (
            <div className="bg-purple-600 text-white p-4 rounded-3xl mb-6 shadow-lg shadow-purple-100 flex items-center justify-between">
              <p className="text-xs font-bold">أنت تتصفح كضيف. أنشئ حساباً دائماً لحفظ بياناتك!</p>
              <button onClick={() => signOut(auth)} className="bg-white text-purple-600 px-4 py-1.5 rounded-xl text-[10px] font-black">تسجيل كامل</button>
            </div>
          )}

          {currentPage === 'feed' && (
            <div className="space-y-6">
              <PostCard 
                post={{
                  userName: ADMIN_ACCOUNT.name,
                  userPhoto: ADMIN_ACCOUNT.photoURL,
                  content: `مرحباً بك! يمكنك الآن تجربة تطبيق doncod فوراً عبر خيار "الدخول كضيف" دون الحاجة لبريد إلكتروني. استمتع! ✨`,
                  likes: [ADMIN_ID],
                  isVerified: true,
                  createdAt: Date.now()
                }}
                isStatic
              />
              {posts.map(post => (
                <PostCard 
                  key={post.id} 
                  post={post} 
                  currentUserId={user.uid}
                  onLike={async () => {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'posts', post.id);
                    await updateDoc(ref, { 
                      likes: post.likes?.includes(user.uid) ? arrayRemove(user.uid) : arrayUnion(user.uid) 
                    });
                  }}
                />
              ))}
            </div>
          )}

          {currentPage === 'profile' && <ProfileSection profile={profile} posts={posts.filter(p => p.userId === user.uid)} />}
          {currentPage === 'create' && (
            <CreatePostSection onPost={async (content, url) => {
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), {
                userId: user.uid,
                userName: profile.name,
                userPhoto: profile.photoURL,
                content,
                mediaUrl: url,
                likes: [],
                createdAt: Date.now()
              });
              setCurrentPage('feed');
            }} />
          )}
        </div>
      </main>

      {/* Mobile Nav */}
      <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 flex justify-around p-4 z-50 shadow-lg">
        <button onClick={() => setCurrentPage('feed')}><Home className={currentPage === 'feed' ? 'text-purple-600' : 'text-slate-400'} /></button>
        <button onClick={() => setCurrentPage('search')}><Search className={currentPage === 'search' ? 'text-purple-600' : 'text-slate-400'} /></button>
        <button onClick={() => setCurrentPage('create')}><PlusSquare className={currentPage === 'create' ? 'text-purple-600' : 'text-slate-400'} /></button>
        <button onClick={() => setCurrentPage('profile')}><User className={currentPage === 'profile' ? 'text-purple-600' : 'text-slate-400'} /></button>
      </nav>
    </div>
  );
}

// --- Components ---

function SideLink({ icon, label, active, onClick }) {
  return (
    <button onClick={onClick} className={`flex items-center gap-4 p-4 w-full rounded-2xl transition-all ${active ? 'bg-purple-600 text-white shadow-lg shadow-purple-100' : 'text-slate-600 hover:bg-slate-50'}`}>
      {React.cloneElement(icon, { size: 22 })}
      <span className="font-bold">{label}</span>
    </button>
  );
}

function PostCard({ post, onLike, currentUserId, isStatic }) {
  const [isReading, setIsReading] = useState(false);
  const isLiked = post.likes?.includes(currentUserId);
  const handleRead = async () => {
    setIsReading(true);
    await playTTS(post.content);
    setIsReading(false);
  };

  return (
    <div className="bg-white rounded-[2.5rem] border border-slate-50 p-6 shadow-sm hover:shadow-md transition-shadow group">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <img src={post.userPhoto} className="w-12 h-12 rounded-2xl object-cover border border-slate-100" />
          <div>
            <h4 className="font-bold text-sm flex items-center gap-1">
              {post.userName}
              {post.isVerified && <BadgeCheck size={14} className="text-purple-600 fill-purple-100" />}
            </h4>
            <p className="text-[10px] text-slate-400 font-medium">عبر doncod AI ✨</p>
          </div>
        </div>
        <button onClick={handleRead} disabled={isReading} className={`p-2 rounded-xl transition-all ${isReading ? 'bg-purple-100 text-purple-600 animate-pulse' : 'bg-slate-50 text-slate-400 hover:text-purple-600'}`}><Volume2 size={18} /></button>
      </div>
      <p className="text-sm text-slate-700 leading-relaxed mb-4">{post.content}</p>
      {post.mediaUrl && <img src={post.mediaUrl} className="w-full h-64 object-cover rounded-3xl mb-4 shadow-inner" />}
      {!isStatic && (
        <div className="flex items-center gap-4 border-t border-slate-50 pt-4">
          <button onClick={onLike} className="flex items-center gap-2 group/like">
            <Heart size={20} className={isLiked ? 'text-red-500 fill-red-500' : 'text-slate-400 group-hover/like:text-red-500'} />
            <span className="text-xs font-bold text-slate-600">{post.likes?.length || 0}</span>
          </button>
          <button className="flex items-center gap-2"><MessageCircle size={20} className="text-slate-400" /><span className="text-xs font-bold text-slate-600">0</span></button>
        </div>
      )}
    </div>
  );
}

function CreatePostSection({ onPost }) {
  const [content, setContent] = useState('');
  const [url, setUrl] = useState('');
  const [isAiLoading, setIsAiLoading] = useState(false);
  const handleAiRefine = async () => {
    if (!content) return;
    setIsAiLoading(true);
    try {
      const refined = await fetchGemini(`Refine this social media post in Arabic: ${content}`, "Expert AI content writer for doncod.");
      if (refined) setContent(refined.trim());
    } catch (e) {} finally { setIsAiLoading(false); }
  };

  return (
    <div className="bg-white rounded-[3rem] p-8 border border-slate-100 shadow-sm">
      <h3 className="text-xl font-black mb-6">أنشئ منشوراً ذكياً</h3>
      <div className="relative mb-4">
        <textarea 
          placeholder="ماذا يدور في ذهنك؟"
          className="w-full bg-slate-50 rounded-3xl p-6 min-h-[150px] outline-none focus:ring-2 focus:ring-purple-100 text-sm"
          value={content} onChange={e => setContent(e.target.value)}
        />
        <button onClick={handleAiRefine} disabled={isAiLoading || !content} className="absolute left-4 bottom-4 flex items-center gap-2 bg-white px-4 py-2 rounded-2xl shadow-sm text-xs font-black text-purple-600 disabled:opacity-50">
          {isAiLoading ? <Loader2 size={14} className="animate-spin" /> : <Wand2 size={14} />}
          تحسين بالذكاء ✨
        </button>
      </div>
      <div className="relative mb-6">
        <input placeholder="رابط الصورة" className="w-full bg-slate-50 rounded-2xl p-4 pr-12 outline-none focus:ring-2 focus:ring-purple-100 text-sm" value={url} onChange={e => setUrl(e.target.value)} />
        <ImageIcon className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
      </div>
      <button disabled={!content || isAiLoading} onClick={() => { onPost(content, url); setContent(''); setUrl(''); }} className="w-full bg-purple-600 text-white py-4 rounded-2xl font-black text-lg">نشر الآن</button>
    </div>
  );
}

function ProfileSection({ profile, posts }) {
  if (!profile) return null;
  return (
    <div className="space-y-6">
      <div className="bg-white rounded-[3rem] p-8 border border-slate-100 shadow-sm text-center">
        {/* تغيير هنا: أيقونة بدلاً من الصورة للملف الشخصي */}
        <div className="w-24 h-24 rounded-[2.5rem] bg-slate-50 border border-slate-100 mx-auto mb-4 flex items-center justify-center shadow-inner group">
          <div className="bg-white p-4 rounded-3xl shadow-sm group-hover:scale-110 transition-transform">
            <User size={40} className="text-purple-600" />
          </div>
        </div>
        
        <h2 className="text-2xl font-black text-slate-900">{profile.name}</h2>
        <p className="text-slate-400 text-sm mt-1">{profile.bio}</p>
        <div className="flex justify-center gap-8 mt-6">
          <StatItem label="منشورات" value={posts.length} />
          <StatItem label="متابعين" value={profile.followers} />
          <StatItem label="أتابع" value={profile.following} />
        </div>
      </div>
      <div className="grid grid-cols-2 gap-4">
        {posts.map(p => (
          <div key={p.id} className="aspect-square rounded-[2rem] overflow-hidden bg-white border border-slate-50 shadow-sm relative group">
            {p.mediaUrl ? <img src={p.mediaUrl} className="w-full h-full object-cover" /> : <div className="p-4 text-[10px] text-slate-400 flex items-center justify-center h-full text-center">{p.content.substring(0, 50)}...</div>}
          </div>
        ))}
      </div>
    </div>
  );
}

const StatItem = ({ label, value }) => (
  <div><span className="block font-black text-xl text-slate-900">{value}</span><span className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">{label}</span></div>
);
